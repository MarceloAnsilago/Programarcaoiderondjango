{% extends "base.html" %}
{% block content %}

<!-- TUDO que n√£o √© mapa recebe class="no-print" -->
<div class="container mt-4 no-print">
    <h2>
        <i class="bi bi-moon" style="color: #073074;"></i>
        Descanso dos Servidores
    </h2>

    <!-- üîç FILTRO POR CRIADO_EM -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="filtro-criado-em" class="form-label"><strong>Filtrar por data de cria√ß√£o:</strong></label>
            <select id="filtro-criado-em" class="form-select">
                <option value="">-- Todos os Anos --</option>
                {% for ano in datas_unicas %}
                    <option value="{{ ano }}">{{ ano }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <script>
        // Remove op√ß√µes duplicadas do select
        window.addEventListener("DOMContentLoaded", function () {
            const select = document.getElementById("filtro-criado-em");
            const seen = {};
            Array.from(select.options).forEach((opt, index) => {
                if (opt.value && seen[opt.value]) {
                    select.removeChild(opt);
                } else {
                    seen[opt.value] = true;
                }
            });
        });
    </script>
    <!-- TABELA DE SERVIDORES -->
    <table class="table table-bordered align-middle">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Cargo</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for s in servidores %}
            <tr>
                <td>
                    <button class="btn btn-link p-0 toggle-descansos"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#descansos-{{ s.id }}"
                            aria-expanded="false"
                            aria-controls="descansos-{{ s.id }}">
                        <i class="bi bi-caret-right-fill" id="icon-{{ s.id }}"></i>
                    </button>
                    <strong>{{ s.nome }}</strong>
                </td>
                <td>{{ s.cargo }}</td>
                <td>{{ s.status }}</td>
                <td>
                    <a href="{% url 'adicionar_descanso' servidor_id=s.id %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Inserir
                    </a>
                </td>
            </tr>
            <tr class="collapse" id="descansos-{{ s.id }}">
                <td colspan="4">
                    <b>Per√≠odos de Descanso</b>
                    <table class="table table-sm table-bordered mt-2 mb-0">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>In√≠cio</th>
                                <th>Fim</th>
                                <th>Observa√ß√£o / A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in s.descansos %}
                            <tr data-criado-em="{{ d.criado_em|date:'Y-m-d' }}">
                                <td>{{ d.tipo }}</td>
                                <td>{{ d.data_inicio }}</td>
                                <td>{{ d.data_fim }}</td>
                                <td>
                                    {{ d.observacao }}
                                    <div class="d-flex gap-1 mt-1">
                                        <a href="{% url 'editar_descanso' descanso_id=d.id %}" class="btn btn-outline-primary btn-sm" title="Editar">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <form action="{% url 'excluir_descanso' descanso_id=d.id %}" method="post" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Excluir" onclick="return confirm('Tem certeza que deseja excluir este per√≠odo?');">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4">Nenhum per√≠odo cadastrado.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- T√çTULO E BOT√ÉO DE IMPRESS√ÉO -->
<div class="container no-print" style="margin-top:2.5rem; margin-bottom:0.7rem;">
    <h3 style="font-weight:bold;">
        <i class="bi bi-geo-alt" style="color:#073074;"></i>
        Mapa / Escala de F√©rias {{ ano }}
    </h3>
    <button class="btn btn-map-print" onclick="printDivConteudo('mapa-escala-imprimir')">
        <i class="bi bi-printer"></i> Imprimir Mapa
    </button>
</div>

<!-- MAPA ESCONDIDO PARA IMPRESS√ÉO -->
<div class="container mt-4 only-print" id="mapa-escala-imprimir" style="display:none;">
    <h3 style="margin: 0 0 10px 0; font-weight: bold;">
        <i class="bi bi-geo-alt" style="color:#073074;"></i>
        Mapa / Escala de F√©rias {{ ano }}
    </h3>
    <hr>
    <div>
        {% for mes in meses %}
            {% if mes.linhas_servidor %}
                <div class="mb-3 border p-2">
                    <div class="mb-2 text-center" style="font-weight:bold; font-size:1.3em;">
                        {{ mes.nome }} {{ ano }}
                    </div>
                    {% for linha in mes.linhas_servidor %}
                        <div style="margin-left:20px; font-weight:bold;">{{ linha.nome }}</div>
                        <div style="margin-left:20px;">
                            {% for dia in mes.dias %}
                                {% if dia in linha.periodos_dias %}
                                    <span class="dia-ferias">{{ dia }}</span>
                                {% else %}
                                    <span class="dia-normal">{{ dia }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="mt-4" style="font-size:0.9em; font-style:italic;">
        Legenda: <span class="dia-ferias">&nbsp;</span>
        Dias em preto indicam o per√≠odo de f√©rias do servidor.
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Filtro por ANO de criado_em
    document.getElementById("filtro-criado-em").addEventListener("change", function () {
        const filtro = this.value;

        // Filtra cada linha de descanso por ano
        document.querySelectorAll("tr[data-criado-em]").forEach(row => {
            const criado_em = row.getAttribute("data-criado-em");
            const ano = criado_em ? new Date(criado_em).getFullYear().toString() : "";

            const show = !filtro || ano === filtro;
            row.style.display = show ? "" : "none";
        });

        // Mostra/oculta a linha colaps√°vel do servidor com base nos descansos vis√≠veis
        document.querySelectorAll("tr[id^='descansos-']").forEach(wrapper => {
            const visiveis = wrapper.querySelectorAll("tbody tr[data-criado-em]:not([style*='display: none'])").length;
            wrapper.style.display = visiveis ? "" : "none";
        });
    });

    // Toggle seta de colapso
document.getElementById("filtro-criado-em").addEventListener("change", function () {
    const filtro = this.value;

    // Para cada linha colaps√°vel (descansos do servidor)
    document.querySelectorAll("tr[id^='descansos-']").forEach(wrapper => {
        const rows = wrapper.querySelectorAll("tr[data-criado-em]");
        let algumVisivel = false;

        rows.forEach(row => {
            const criado_em = row.getAttribute("data-criado-em");
            const ano = criado_em ? new Date(criado_em).getFullYear().toString() : "";

            const visivel = !filtro || ano === filtro;
            row.style.display = visivel ? "" : "none";

            if (visivel) {
                algumVisivel = true;
            }
        });

        // Mostra ou esconde o bloco do servidor
        wrapper.style.display = algumVisivel ? "" : "none";
    });
});

    // Impress√£o do mapa
    function printDivConteudo(divId) {
        var div = document.getElementById(divId);
        if (!div) return alert('Bloco n√£o encontrado: ' + divId);
        var conteudo = div.innerHTML;
        var style = `
            <style>
                @page { size: landscape; }
                body { margin: 2em; font-family: Arial, sans-serif; }
                .dia-ferias, .dia-normal {
                    display: inline-flex;
                    width: 22px;
                    height: 22px;
                    justify-content: center;
                    align-items: center;
                    font-size: 13px;
                    border: 1px solid #555;
                }
                .dia-ferias { background: #111; color: #fff; }
                .dia-normal { background: #fff; color: #111; }
                .no-print, button { display: none !important; }
            </style>
        `;
        var win = window.open('', '', 'width=1100,height=800');
        win.document.write(`<html><head><title>Impress√£o</title>${style}</head><body>${conteudo}</body></html>`);
        win.document.close();
        win.onload = function () {
            win.focus(); win.print(); setTimeout(() => win.close(), 200);
        };
    }
</script>
{% endblock %}

{% block extra_css %}
<style>
.dia-ferias, .dia-normal {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    margin: 1px;
    font-size: 13px;
    border-radius: 4px;
}
.dia-ferias {
    background: #007bff;
    color: #fff;
    border: 1.5px solid #0056b3;
}
.dia-normal {
    background: #f0f0f0;
    color: #111;
    border: 1px solid #ccc;
}
.btn-map-print {
    background: linear-gradient(90deg, #1363c6 0%, #0d396a 100%);
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    padding: 0.65em 1.4em;
    font-size: 1.07em;
    box-shadow: 0 2px 10px rgba(19, 99, 198, 0.10);
}
.btn-map-print:hover {
    background: linear-gradient(90deg, #1d82e9 0%, #073074 100%);
    color: #fff;
}
.only-print { display: none !important; }
@media print {
    .only-print { display: block !important; }
    .no-print, .sidebar, nav, header, button { display: none !important; }
    .container { width: 100%; max-width: 100%; }
}
</style>
{% endblock %}
